{"version":3,"sources":["file:///Users/edz/work/creatorproject/3.3.1/test/assets/label/font-utils.ts"],"names":["computeHash","labelInfo","hashData","color","toHEX","out","isOutlined","margin","fontSize","fontFamily","BASELINE_RATIO","Color","director","Director","getBaselineOffset","ImageAsset","js","macro","MIDDLE_RATIO","safeMeasureText","Texture2D","warnID","CanvasPool","getInstance","_canvasPool","get","data","pool","pop","canvas","document","createElement","context","getContext","put","length","MAX_LABEL_CANVAS_POOL_SIZE","push","WHITE","clone","space","bleed","FontLetterDefinition","_backgroundStyle","toFixed","BASELINE_OFFSET","LetterTexture","char","hash","charCodeAt","updateRenderData","_updateProperties","_updateTexture","destroy","image","font","fontDesc","width","blank","parseFloat","height","offsetY","reset","textAlign","textBaseline","clearRect","fillStyle","fillRect","startX","startY","lineJoin","r","g","b","strokeColor","strokeStyle","a","lineWidth","strokeText","fillText","PixelFormat","RGBA8888","LetterRenderTexture","initWithSize","format","drawTextureAt","x","y","gfxTexture","getGFXTexture","gfxDevice","_getGFXDevice","console","warn","region","BufferTextureCopy","texOffset","texExtent","copyTexImagesToTexture","ECharCacheType","LetterAtlas","normal","fontDefDictionary","Map","key","texture","set","Number","FontAtlas","_halfBleed","_width","_height","on","EVENT_BEFORE_SCENE_LAUNCH","beforeSceneLoad","insertLetterTexture","letterTexture","charCacheType","device","root","has","_x","_y","_nextY","_dirty","letterDefinition","u","v","valid","w","h","xAdvance","addLetterDefinitions","update","values","value","clear","getTexture","_charCacheType","clearAllCache","getLetter","letterDefinitions","getLetterDefinitionForChar","letter","temp","shareLabelInfo","fontAtlas","lineHeight","hAlign","vAlign","buffStride","buffTexHeight","texSubres","Offset","Extent","TextureSubresLayers","copy","info","z","depth","mipLevel","baseArrayLayer","layerCount","cloneLetterDefinition","copyLetterDefinitions","Object","keys","mixin","hasKey","hasOwnProperty"],"mappings":"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","sourcesContent":["/*\r\n Copyright (c) 2020 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated engine source code (the \"Software\"), a limited,\r\n worldwide, royalty-free, non-assignable, revocable and non-exclusive license\r\n to use Cocos Creator solely to develop games on your target platforms. You shall\r\n not use Cocos Creator software for developing other software or tools that's\r\n used for developing games. You are not granted to publish, distribute,\r\n sublicense, and/or sell copies of Cocos Creator.\r\n\r\n The software or tools in this License Agreement are licensed, not sold.\r\n Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n */\r\n\r\nimport { BASELINE_RATIO, Color, director, Director, error, getBaselineOffset, ImageAsset, js, macro, MIDDLE_RATIO, safeMeasureText, Texture2D, warnID } from \"cc\";\r\n\r\n/**\r\n * @packageDocumentation\r\n * @hidden\r\n */\r\n\r\nexport interface ISharedLabelData {\r\n\tcanvas: HTMLCanvasElement;\r\n\tcontext: CanvasRenderingContext2D | null;\r\n}\r\n\r\nlet _canvasPool: CanvasPool;\r\n\r\nexport class CanvasPool {\r\n\tstatic getInstance(): CanvasPool {\r\n\t\tif (!_canvasPool) {\r\n\t\t\t_canvasPool = new CanvasPool();\r\n\t\t}\r\n\t\treturn _canvasPool;\r\n\t}\r\n\tpublic pool: ISharedLabelData[] = [];\r\n\tpublic get() {\r\n\t\tlet data = this.pool.pop();\r\n\r\n\t\tif (!data) {\r\n\t\t\tconst canvas = document.createElement(\"canvas\");\r\n\t\t\tconst context = canvas.getContext(\"2d\");\r\n\t\t\tdata = {\r\n\t\t\t\tcanvas,\r\n\t\t\t\tcontext,\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\treturn data;\r\n\t}\r\n\r\n\tpublic put(canvas: ISharedLabelData) {\r\n\t\tif (this.pool.length >= macro.MAX_LABEL_CANVAS_POOL_SIZE) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.pool.push(canvas);\r\n\t}\r\n}\r\n\r\n// export function packToDynamicAtlas(comp, frame) {\r\n//     // TODO: Material API design and export from editor could affect the material activation process\r\n//     // need to update the logic here\r\n//     if (frame && !TEST) {\r\n//         if (!frame._original && dynamicAtlasManager) {\r\n//             let packedFrame = dynamicAtlasManager.insertSpriteFrame(frame);\r\n//             if (packedFrame) {\r\n//                 frame._setDynamicAtlasFrame(packedFrame);\r\n//             }\r\n//         }\r\n//         if (comp.sharedMaterials[0].getProperty('texture') !== frame._texture) {\r\n//             comp._activateMaterial();\r\n//         }\r\n//     }\r\n// }\r\n\r\ninterface ILabelInfo {\r\n\tfontSize: number;\r\n\tlineHeight: number;\r\n\thash: string;\r\n\tfontFamily: string;\r\n\tfontDesc: string;\r\n\thAlign: number;\r\n\tvAlign: number;\r\n\tcolor: Color;\r\n\tisOutlined: boolean;\r\n\tout: Color;\r\n\tmargin: number;\r\n}\r\n\r\nconst WHITE = Color.WHITE.clone();\r\nconst space = 0;\r\nconst bleed = 2;\r\n\r\nclass FontLetterDefinition {\r\n\tpublic u = 0;\r\n\tpublic v = 0;\r\n\tpublic w = 0;\r\n\tpublic h = 0;\r\n\tpublic texture: LetterRenderTexture | null = null;\r\n\tpublic offsetX = 0;\r\n\tpublic offsetY = 0;\r\n\tpublic valid = false;\r\n\tpublic xAdvance = 0;\r\n}\r\n\r\nconst _backgroundStyle = `rgba(255, 255, 255, ${(1 / 255).toFixed(3)})`;\r\nconst BASELINE_OFFSET = getBaselineOffset();\r\n\r\nclass LetterTexture {\r\n\tpublic image: ImageAsset | null = null;\r\n\tpublic labelInfo: ILabelInfo;\r\n\tpublic char: string;\r\n\tpublic data: ISharedLabelData | null = null;\r\n\tpublic canvas: HTMLCanvasElement | null = null;\r\n\tpublic context: CanvasRenderingContext2D | null = null;\r\n\tpublic width = 0;\r\n\tpublic height = 0;\r\n\tpublic offsetY = 0;\r\n\tpublic hash: string;\r\n\tconstructor(char: string, labelInfo: ILabelInfo) {\r\n\t\tthis.char = char;\r\n\t\tthis.labelInfo = labelInfo;\r\n\t\tthis.hash = char.charCodeAt(0) + labelInfo.hash;\r\n\t}\r\n\r\n\tpublic updateRenderData() {\r\n\t\tthis._updateProperties();\r\n\t\tthis._updateTexture();\r\n\t}\r\n\r\n\tpublic destroy() {\r\n\t\tthis.image = null;\r\n\t\t// Label._canvasPool.put(this._data);\r\n\t}\r\n\r\n\tprivate _updateProperties() {\r\n\t\tthis.data = CanvasPool.getInstance().get();\r\n\t\tthis.canvas = this.data.canvas;\r\n\t\tthis.context = this.data.context;\r\n\t\tif (this.context) {\r\n\t\t\tthis.context.font = this.labelInfo.fontDesc;\r\n\t\t\tconst width = safeMeasureText(this.context, this.char, this.labelInfo.fontDesc);\r\n\t\t\tconst blank = this.labelInfo.margin * 2 + bleed;\r\n\t\t\tthis.width = parseFloat(width.toFixed(2)) + blank;\r\n\t\t\tthis.height = (1 + BASELINE_RATIO) * this.labelInfo.fontSize + blank;\r\n\t\t\tthis.offsetY = -(this.labelInfo.fontSize * BASELINE_RATIO) / 2;\r\n\t\t}\r\n\r\n\t\tif (this.canvas.width !== this.width) {\r\n\t\t\tthis.canvas.width = this.width;\r\n\t\t}\r\n\r\n\t\tif (this.canvas.height !== this.height) {\r\n\t\t\tthis.canvas.height = this.height;\r\n\t\t}\r\n\r\n\t\tif (!this.image) {\r\n\t\t\tthis.image = new ImageAsset();\r\n\t\t}\r\n\r\n\t\tthis.image.reset(this.canvas);\r\n\t}\r\n\r\n\tprivate _updateTexture() {\r\n\t\tif (!this.context || !this.canvas) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst context = this.context;\r\n\t\tconst labelInfo = this.labelInfo;\r\n\t\tconst width = this.canvas.width;\r\n\t\tconst height = this.canvas.height;\r\n\r\n\t\tcontext.textAlign = \"center\";\r\n\t\tcontext.textBaseline = \"alphabetic\";\r\n\t\tcontext.clearRect(0, 0, width, height);\r\n\t\t// Add a white background to avoid black edges.\r\n\t\tcontext.fillStyle = _backgroundStyle;\r\n\t\tcontext.fillRect(0, 0, width, height);\r\n\t\tcontext.font = labelInfo.fontDesc;\r\n\r\n\t\tconst fontSize = labelInfo.fontSize;\r\n\t\tconst startX = width / 2;\r\n\t\tconst startY = height / 2 + fontSize * MIDDLE_RATIO + fontSize * BASELINE_OFFSET;\r\n\t\tconst color = labelInfo.color;\r\n\t\t// use round for line join to avoid sharp intersect point\r\n\t\tcontext.lineJoin = \"round\";\r\n\t\tcontext.fillStyle = `rgba(${color.r}, ${color.g}, ${color.b}, ${1})`;\r\n\t\tif (labelInfo.isOutlined) {\r\n\t\t\tconst strokeColor = labelInfo.out || WHITE;\r\n\t\t\tcontext.strokeStyle = `rgba(${strokeColor.r}, ${strokeColor.g}, ${strokeColor.b}, ${strokeColor.a / 255})`;\r\n\t\t\tcontext.lineWidth = labelInfo.margin * 2;\r\n\t\t\tcontext.strokeText(this.char, startX, startY);\r\n\t\t}\r\n\t\tcontext.fillText(this.char, startX, startY);\r\n\r\n\t\t// this.texture.handleLoadedTexture();\r\n\t\t// (this.image as Texture2D).updateImage();\r\n\t}\r\n}\r\n\r\nconst PixelFormat = { RGBA8888: 35 };\r\n\r\nexport class LetterRenderTexture extends Texture2D {\r\n\t/**\r\n\t * @en\r\n\t * Init the render texture with size.\r\n\t * @zh\r\n\t * 初始化 render texture。\r\n\t * @param [width]\r\n\t * @param [height]\r\n\t * @param [string]\r\n\t */\r\n\tpublic initWithSize(width: number, height: number, format: number = PixelFormat.RGBA8888) {\r\n\t\tthis.reset({\r\n\t\t\twidth,\r\n\t\t\theight,\r\n\t\t\tformat,\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @en Draw a texture to the specified position\r\n\t * @zh 将指定的图片渲染到指定的位置上。\r\n\t * @param {Texture2D} image\r\n\t * @param {Number} x\r\n\t * @param {Number} y\r\n\t */\r\n\tpublic drawTextureAt(image: ImageAsset, x: number, y: number) {\r\n\t\tconst gfxTexture = this.getGFXTexture();\r\n\t\tif (!image || !gfxTexture) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst gfxDevice = this._getGFXDevice();\r\n\t\tif (!gfxDevice) {\r\n\t\t\tconsole.warn(\"Unable to get device\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst region = new BufferTextureCopy();\r\n\t\tregion.texOffset.x = x;\r\n\t\tregion.texOffset.y = y;\r\n\t\tregion.texExtent.width = image.width;\r\n\t\tregion.texExtent.height = image.height;\r\n\t\tgfxDevice.copyTexImagesToTexture([image.data as HTMLCanvasElement], gfxTexture, [region]);\r\n\t}\r\n}\r\nexport enum ECharCacheType {\r\n\tnormal = 1, //不要改\r\n\tmain,\r\n\tdialog,\r\n\tscrollview,\r\n}\r\nexport class LetterAtlas {\r\n\tget width() {\r\n\t\treturn this._width;\r\n\t}\r\n\r\n\tget height() {\r\n\t\treturn this._height;\r\n\t}\r\n\r\n\tprivate _x = space;\r\n\tprivate _y = space;\r\n\tprivate _nextY = space;\r\n\tprivate _width = 0;\r\n\tprivate _height = 0;\r\n\tprivate _halfBleed = 0;\r\n\tpublic declare fontDefDictionary: Map<number, FontAtlas>;\r\n\tprivate _dirty = false;\r\n\r\n\tprivate _charCacheType = ECharCacheType.normal;\r\n\r\n\tconstructor(width: number, height: number) {\r\n\t\t//TODO: 待优化\r\n        this.fontDefDictionary = new Map();\r\n\t\tfor (let key in ECharCacheType) {\r\n\t\t\tconst texture = new LetterRenderTexture();\r\n\t\t\ttexture.initWithSize(width, height);\r\n\t\t\tthis.fontDefDictionary.set(Number(ECharCacheType[key]), new FontAtlas(texture));\r\n\t\t}\r\n\t\t//TODO: 待优化\r\n\r\n\t\tthis._halfBleed = bleed / 2;\r\n\t\tthis._width = width;\r\n\t\tthis._height = height;\r\n\t\tdirector.on(Director.EVENT_BEFORE_SCENE_LAUNCH, this.beforeSceneLoad, this);\r\n\t}\r\n\r\n\tpublic insertLetterTexture(letterTexture: LetterTexture, charCacheType) {\r\n\t\tconst texture = letterTexture.image;\r\n\t\tconst device = director.root!.device;\r\n\t\tif (!texture || !this.fontDefDictionary.has(charCacheType) || !device) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tconst width = texture.width;\r\n\t\tconst height = texture.height;\r\n\r\n\t\tif (this._x + width + space > this._width) {\r\n\t\t\tthis._x = space;\r\n\t\t\tthis._y = this._nextY;\r\n\t\t}\r\n\r\n\t\tif (this._y + height > this._nextY) {\r\n\t\t\tthis._nextY = this._y + height + space;\r\n\t\t}\r\n\r\n\t\tif (this._nextY > this._height) {\r\n\t\t\twarnID(12100);\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tthis.fontDefDictionary.get(charCacheType).texture.drawTextureAt(texture, this._x, this._y);\r\n\r\n\t\tthis._dirty = true;\r\n\r\n\t\tconst letterDefinition = new FontLetterDefinition();\r\n\t\tletterDefinition.u = this._x + this._halfBleed;\r\n\t\tletterDefinition.v = this._y + this._halfBleed;\r\n\t\tletterDefinition.texture = this.fontDefDictionary.get(charCacheType).texture;\r\n\t\tletterDefinition.valid = true;\r\n\t\tletterDefinition.w = letterTexture.width - bleed;\r\n\t\tletterDefinition.h = letterTexture.height - bleed;\r\n\t\tletterDefinition.xAdvance = letterDefinition.w;\r\n\t\tletterDefinition.offsetY = letterTexture.offsetY;\r\n\r\n\t\tthis._x += width + space;\r\n\t\tthis.fontDefDictionary.get(charCacheType).addLetterDefinitions(letterTexture.hash, letterDefinition);\r\n\r\n\t\tthis.fontDefDictionary.get(charCacheType)._x = this._x;\r\n\t\tthis.fontDefDictionary.get(charCacheType)._y = this._y;\r\n\t\tthis.fontDefDictionary.get(charCacheType)._nextY = this._nextY;\r\n\t\t/*\r\n        const region = new BufferTextureCopy();\r\n        region.texOffset.x = letterDefinition.offsetX;\r\n        region.texOffset.y = letterDefinition.offsetY;\r\n        region.texExtent.width = letterDefinition.w;\r\n        region.texExtent.height = letterDefinition.h;\r\n        */\r\n\r\n\t\treturn letterDefinition;\r\n\t}\r\n\r\n\tpublic update() {\r\n\t\tif (!this._dirty) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// this.texture.update();\r\n\t\tthis._dirty = false;\r\n\t}\r\n\r\n\tpublic reset() {\r\n\t\tthis._x = space;\r\n\t\tthis._y = space;\r\n\t\tthis._nextY = space;\r\n\r\n\t\t// const chars = this.letterDefinitions;\r\n\t\t// for (let i = 0, l = (Object.keys(chars)).length; i < l; i++) {\r\n\t\t//     const char = chars[i];\r\n\t\t//     if (!char.valid) {\r\n\t\t//         continue;\r\n\t\t//     }\r\n\t\t//     char.destroy();\r\n\t\t// }\r\n\r\n\t\t// this.letterDefinitions = createMap();\r\n\t\tfor (let value of this.fontDefDictionary.values()) {\r\n\t\t\tvalue.clear();\r\n\t\t}\r\n\t}\r\n\r\n\tpublic destroy() {\r\n\t\tthis.reset();\r\n\t\tfor (let value of this.fontDefDictionary.values()) {\r\n\t\t\tvalue.texture.destroy();\r\n\t\t\tvalue.texture.texture = null;\r\n\t\t}\r\n\t\tthis.fontDefDictionary.clear();\r\n\t}\r\n\r\n\tgetTexture(charCacheType) {\r\n\t\tif (!charCacheType) charCacheType = this._charCacheType;\r\n\t\tif (this.fontDefDictionary.has(charCacheType)) {\r\n\t\t\treturn this.fontDefDictionary.get(charCacheType).getTexture();\r\n\t\t}\r\n\t\treturn this.fontDefDictionary.get(this._charCacheType).getTexture();\r\n\t}\r\n\r\n\tpublic beforeSceneLoad() {\r\n\t\tthis.clearAllCache();\r\n\t}\r\n\r\n\tpublic clearAllCache() {\r\n\t\tthis.destroy();\r\n\r\n\t\tfor (let value of this.fontDefDictionary.values()) {\r\n\t\t\tconst texture = new LetterRenderTexture();\r\n\t\t\ttexture.initWithSize(this._width, this._height);\r\n\t\t\tvalue.texture.texture = texture;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic getLetter(key: string, charCacheType) {\r\n\t\tif (!charCacheType) charCacheType = this._charCacheType;\r\n\t\treturn this.fontDefDictionary.get(charCacheType).letterDefinitions[key];\r\n\t}\r\n\r\n\tpublic getLetterDefinitionForChar(char: string, labelInfo: ILabelInfo, charCacheType) {\r\n\t\tif (!this.fontDefDictionary.has(charCacheType)) {\r\n\t\t\tconst texture = new LetterRenderTexture();\r\n\t\t\ttexture.initWithSize(this.width, this.height);\r\n\t\t\tthis.fontDefDictionary.set(charCacheType, new FontAtlas(texture));\r\n\t\t}\r\n\t\tthis._x = this.fontDefDictionary.get(charCacheType)._x;\r\n\t\tthis._y = this.fontDefDictionary.get(charCacheType)._y;\r\n\t\tthis._nextY = this.fontDefDictionary.get(charCacheType)._nextY;\r\n\t\tconst hash = char.charCodeAt(0) + labelInfo.hash;\r\n\t\tlet letter = this.fontDefDictionary.get(charCacheType).letterDefinitions[hash];\r\n\t\tif (!letter) {\r\n\t\t\tconst temp = new LetterTexture(char, labelInfo);\r\n\t\t\ttemp.updateRenderData();\r\n\t\t\tletter = this.insertLetterTexture(temp, charCacheType);\r\n\t\t\ttemp.destroy();\r\n\t\t}\r\n\t\t// console.log(this.fontDefDictionary)\r\n\t\treturn letter;\r\n\t}\r\n}\r\n\r\nexport interface IShareLabelInfo {\r\n\tfontAtlas: FontAtlas | LetterAtlas | null;\r\n\tfontSize: number;\r\n\tlineHeight: number;\r\n\thAlign: number;\r\n\tvAlign: number;\r\n\thash: string;\r\n\tfontFamily: string;\r\n\tfontDesc: string;\r\n\tcolor: Color;\r\n\tisOutlined: boolean;\r\n\tout: Color;\r\n\tmargin: number;\r\n}\r\n\r\nexport const shareLabelInfo: IShareLabelInfo = {\r\n\tfontAtlas: null,\r\n\tfontSize: 0,\r\n\tlineHeight: 0,\r\n\thAlign: 0,\r\n\tvAlign: 0,\r\n\thash: \"\",\r\n\tfontFamily: \"\",\r\n\tfontDesc: \"Arial\",\r\n\tcolor: Color.WHITE.clone(),\r\n\tisOutlined: false,\r\n\tout: Color.WHITE.clone(),\r\n\tmargin: 0,\r\n};\r\n\r\nexport function computeHash(labelInfo) {\r\n\tconst hashData = \"\";\r\n\tconst color = labelInfo.color.toHEX();\r\n\tlet out = \"\";\r\n\tif (labelInfo.isOutlined && labelInfo.margin > 0) {\r\n\t\tout = out + labelInfo.margin + labelInfo.out.toHEX();\r\n\t}\r\n\r\n\treturn hashData + labelInfo.fontSize + labelInfo.fontFamily + color + out;\r\n}\r\n\r\nexport class BufferTextureCopy {\r\n\tprivate declare _token: never; // to make sure all usages must be an instance of this exact class, not assembled from plain object\r\n\r\n\tconstructor(public buffStride: number = 0, public buffTexHeight: number = 0, public texOffset: Offset = new Offset(), public texExtent: Extent = new Extent(), public texSubres: TextureSubresLayers = new TextureSubresLayers()) {}\r\n\r\n\tpublic copy(info: BufferTextureCopy) {\r\n\t\tthis.buffStride = info.buffStride;\r\n\t\tthis.buffTexHeight = info.buffTexHeight;\r\n\t\tthis.texOffset.copy(info.texOffset);\r\n\t\tthis.texExtent.copy(info.texExtent);\r\n\t\tthis.texSubres.copy(info.texSubres);\r\n\t\treturn this;\r\n\t}\r\n}\r\n\r\nexport class Offset {\r\n\tprivate declare _token: never; // to make sure all usages must be an instance of this exact class, not assembled from plain object\r\n\r\n\tconstructor(public x: number = 0, public y: number = 0, public z: number = 0) {}\r\n\r\n\tpublic copy(info: Offset) {\r\n\t\tthis.x = info.x;\r\n\t\tthis.y = info.y;\r\n\t\tthis.z = info.z;\r\n\t\treturn this;\r\n\t}\r\n}\r\n\r\nexport class Extent {\r\n\tprivate declare _token: never; // to make sure all usages must be an instance of this exact class, not assembled from plain object\r\n\r\n\tconstructor(public width: number = 0, public height: number = 0, public depth: number = 1) {}\r\n\r\n\tpublic copy(info: Extent) {\r\n\t\tthis.width = info.width;\r\n\t\tthis.height = info.height;\r\n\t\tthis.depth = info.depth;\r\n\t\treturn this;\r\n\t}\r\n}\r\nexport class TextureSubresLayers {\r\n\tprivate declare _token: never; // to make sure all usages must be an instance of this exact class, not assembled from plain object\r\n\r\n\tconstructor(public mipLevel: number = 0, public baseArrayLayer: number = 0, public layerCount: number = 1) {}\r\n\r\n\tpublic copy(info: TextureSubresLayers) {\r\n\t\tthis.mipLevel = info.mipLevel;\r\n\t\tthis.baseArrayLayer = info.baseArrayLayer;\r\n\t\tthis.layerCount = info.layerCount;\r\n\t\treturn this;\r\n\t}\r\n}\r\n\r\nexport class FontAtlas {\r\n\tpublic letterDefinitions;\r\n\tpublic texture;\r\n\tpublic _x = space;\r\n\tpublic _y = space;\r\n\tpublic _nextY = space;\r\n\r\n\tconstructor(texture) {\r\n\t\tthis.letterDefinitions = {};\r\n\t\tthis.texture = texture;\r\n\t\tthis._x = 0;\r\n\t\tthis._y = 0;\r\n\t\tthis._nextY = 0;\r\n\t}\r\n\r\n\tpublic addLetterDefinitions(letter, letterDefinition) {\r\n\t\tthis.letterDefinitions[letter] = letterDefinition;\r\n\t}\r\n\r\n\tpublic cloneLetterDefinition() {\r\n\t\tconst copyLetterDefinitions = {};\r\n\t\tfor (const key of Object.keys(this.letterDefinitions)) {\r\n\t\t\tconst value = new FontLetterDefinition();\r\n\t\t\tjs.mixin(value, this.letterDefinitions[key]);\r\n\t\t\tcopyLetterDefinitions[key] = value;\r\n\t\t}\r\n\t\treturn copyLetterDefinitions;\r\n\t}\r\n\r\n\tpublic getTexture() {\r\n\t\treturn this.texture;\r\n\t}\r\n\r\n\tpublic getLetter(key) {\r\n\t\treturn this.letterDefinitions[key];\r\n\t}\r\n\r\n\tpublic getLetterDefinitionForChar(char, labelInfo?) {\r\n\t\tconst key = char.charCodeAt(0);\r\n\t\tconst hasKey = this.letterDefinitions.hasOwnProperty(key);\r\n\t\tlet letter;\r\n\t\tif (hasKey) {\r\n\t\t\tletter = this.letterDefinitions[key];\r\n\t\t} else {\r\n\t\t\tletter = null;\r\n\t\t}\r\n\t\treturn letter;\r\n\t}\r\n\r\n\tpublic clear() {\r\n\t\tthis.letterDefinitions = {};\r\n\t}\r\n}\r\n"]}